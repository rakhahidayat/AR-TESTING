<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR Testing - Cyberpunk Car</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <a-scene
      mindar-image="imageTargetSrc: ./marker.mind;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <img id="card" src="./Target-Car.png" alt="AR target marker for car" />
        <a-asset-item
          id="avatarModel"
          src="./cyberpunk_car_gltf/scene.gltf"
        ></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Lighting for better visibility from all angles -->
      <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
      <a-light
        type="directional"
        position="2 2 2"
        color="#ffffff"
        intensity="1.2"
      ></a-light>
      <a-light
        type="directional"
        position="-2 2 -2"
        color="#ffffff"
        intensity="0.6"
      ></a-light>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane
          src="#card"
          position="0 0 0"
          height="1"
          width="1"
          rotation="0 0 0"
        ></a-plane>
        <a-gltf-model
          id="carModel"
          rotation="-270 -180 -180"
          position="0 0 1"
          scale="0.003 0.003 0.003"
          src="#avatarModel"
          animation__rotate="property: rotation; to: 0 0 0; dur: 20000; easing: easeInOutQuad; loop: true"
        >
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      // Touch rotation and device orientation component for the car
      (function () {
        let isRotating = false;
        let lastTouchX = 0;
        let lastTouchY = 0;
        let currentRotationY = 180; // Initial Y rotation
        let currentRotationX = -5; // Initial X rotation
        let useDeviceOrientation = false;
        let initialBeta = null;
        let initialGamma = null;

        const carModel = document.getElementById("carModel");
        const scene = document.querySelector("a-scene");

        if (!carModel) {
          console.warn("Car model not found");
          return;
        }

        // Get current rotation from the model
        function getCurrentRotation() {
          const rotation = carModel.getAttribute("rotation");
          return {
            x: rotation.x || 0,
            y: rotation.y || 0,
            z: rotation.z || 0,
          };
        }

        // Set rotation on the model
        function setRotation(x, y, z) {
          carModel.setAttribute("rotation", `${x} ${y} ${z}`);
          currentRotationX = x;
          currentRotationY = y;
        }

        // Device orientation handler
        function onDeviceOrientation(event) {
          if (!useDeviceOrientation) return;

          // Beta: front-to-back tilt (-180 to 180)
          // Gamma: left-to-right tilt (-90 to 90)
          const beta = event.beta; // Up/down movement
          const gamma = event.gamma; // Left/right movement

          // Initialize reference angles on first reading
          if (initialBeta === null || initialGamma === null) {
            initialBeta = beta;
            initialGamma = gamma;
            return;
          }

          // Calculate movement deltas
          const deltaBeta = beta - initialBeta;
          const deltaGamma = gamma - initialGamma;

          // Map to 270 degree range
          // Beta (up/down) controls X rotation: -135 to 135 degrees
          // Gamma (left/right) controls Y rotation: -135 to 135 degrees
          const maxRotation = 135; // Half of 270 degrees
          const betaRange = 90; // Typical beta range for phone movement
          const gammaRange = 90; // Typical gamma range for phone movement

          // Scale the movement to 270 degree rotation
          let newRotationX = -5 + (deltaBeta / betaRange) * maxRotation;
          let newRotationY = 180 + (deltaGamma / gammaRange) * maxRotation;

          // Clamp rotations to stay within reasonable bounds
          newRotationX = Math.max(-135, Math.min(135, newRotationX));
          newRotationY = Math.max(45, Math.min(315, newRotationY));

          setRotation(newRotationX, newRotationY, 0);
        }

        // Touch start handler
        function onTouchStart(event) {
          if (event.touches.length === 1) {
            isRotating = true;
            useDeviceOrientation = false; // Disable device orientation during touch
            lastTouchX = event.touches[0].clientX;
            lastTouchY = event.touches[0].clientY;
            event.preventDefault();
          }
        }

        // Touch move handler
        function onTouchMove(event) {
          if (isRotating && event.touches.length === 1) {
            const touchX = event.touches[0].clientX;
            const touchY = event.touches[0].clientY;

            const deltaX = touchX - lastTouchX;
            const deltaY = touchY - lastTouchY;

            // Rotate around Y axis (horizontal swipe)
            const rotationSpeedY = 0.5;
            const rotationSpeedX = 0.3;

            // Update rotation
            let newRotationY = currentRotationY + deltaX * rotationSpeedY;
            let newRotationX = currentRotationX - deltaY * rotationSpeedX;

            // Limit X rotation to prevent flipping
            newRotationX = Math.max(-45, Math.min(45, newRotationX));

            setRotation(newRotationX, newRotationY, 0);

            lastTouchX = touchX;
            lastTouchY = touchY;
            event.preventDefault();
          }
        }

        // Touch end handler
        function onTouchEnd(event) {
          isRotating = false;
          // Re-enable device orientation after touch ends
          setTimeout(() => {
            if (!isRotating) {
              useDeviceOrientation = true;
              initialBeta = null;
              initialGamma = null;
            }
          }, 100);
        }

        // Request device orientation permission
        function requestDeviceOrientation() {
          if (
            typeof DeviceOrientationEvent !== "undefined" &&
            typeof DeviceOrientationEvent.requestPermission === "function"
          ) {
            DeviceOrientationEvent.requestPermission()
              .then((response) => {
                if (response === "granted") {
                  useDeviceOrientation = true;
                  window.addEventListener(
                    "deviceorientation",
                    onDeviceOrientation
                  );
                  console.log("Device orientation permission granted");
                } else {
                  console.log("Device orientation permission denied");
                }
              })
              .catch((error) => {
                console.error("Error requesting device orientation:", error);
              });
          } else {
            // For browsers that don't require permission
            useDeviceOrientation = true;
            window.addEventListener("deviceorientation", onDeviceOrientation);
            console.log("Device orientation enabled (no permission required)");
          }
        }

        // Wait for scene to load
        scene.addEventListener("loaded", () => {
          // Add touch event listeners to the scene canvas
          const canvas = scene.canvas;
          if (canvas) {
            canvas.addEventListener("touchstart", onTouchStart, {
              passive: false,
            });
            canvas.addEventListener("touchmove", onTouchMove, {
              passive: false,
            });
            canvas.addEventListener("touchend", onTouchEnd, { passive: false });
            canvas.addEventListener("touchcancel", onTouchEnd, {
              passive: false,
            });
          }

          // Also add to document body as fallback
          document.body.addEventListener("touchstart", onTouchStart, {
            passive: false,
          });
          document.body.addEventListener("touchmove", onTouchMove, {
            passive: false,
          });
          document.body.addEventListener("touchend", onTouchEnd, {
            passive: false,
          });
          document.body.addEventListener("touchcancel", onTouchEnd, {
            passive: false,
          });

          // Enable device orientation after a short delay
          setTimeout(() => {
            requestDeviceOrientation();
          }, 500);

          console.log("Touch rotation controls enabled");
        });
      })();
    </script>
  </body>
</html>
